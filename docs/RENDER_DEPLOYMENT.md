# Render Deployment Guide

This guide covers deploying the Backstock application to Render, a free Heroku alternative, including automated deployment, database management, and the critical 90-day database rotation process.

## Table of Contents

- [Initial Setup](#initial-setup)
- [Automated Deployment](#automated-deployment)
- [Database Management](#database-management)
- [90-Day Database Rotation](#90-day-database-rotation)
- [Backup and Restore](#backup-and-restore)
- [Troubleshooting](#troubleshooting)

---

## Initial Setup

### 1. Create Render Account

1. Go to [render.com](https://render.com)
2. Sign up with your GitHub account (recommended for auto-deploy)
3. Verify your email address

### 2. Connect GitHub Repository

1. In Render dashboard, click **New +** â†’ **Blueprint**
2. Connect your GitHub account if not already connected
3. Select the `backstock` repository
4. Render will automatically detect the `render.yaml` file

### 3. Configure Environment Variables

The `render.yaml` file automatically configures most variables, but you may need to verify:

- `SECRET_KEY` - Auto-generated by Render
- `DATABASE_URL` - Auto-connected from the database service
- `APP_SETTINGS` - Set to `config.ProductionConfig`

### 4. Deploy

1. Click **Apply** to create the services
2. Render will:
   - Create the PostgreSQL database (`backstock-db`)
   - Create the web service (`backstock`)
   - Build and deploy the application
   - Set up SSL certificates automatically

3. Wait 5-10 minutes for initial deployment
4. Access your app at: `https://backstock.onrender.com` (or your assigned URL)

---

## Automated Deployment

### Auto-Deploy from GitHub

With the `render.yaml` configuration, deployments are automatic:

```yaml
autoDeploy: true
branch: main
```

**Workflow:**
1. Merge PR to `main` branch
2. GitHub Actions runs tests and linting (`.github/workflows/deploy.yml`)
3. If tests pass, Render automatically detects the push
4. Render builds and deploys the new version
5. Zero-downtime deployment

**Monitoring Deployments:**
- Visit [Render Dashboard](https://dashboard.render.com)
- Select your `backstock` service
- View **Events** tab for deployment logs

---

## Database Management

### Database Specifications (Free Tier)

- **Type:** PostgreSQL
- **Storage:** 1 GB
- **Plan:** Free
- **âš ï¸ CRITICAL:** Database expires after **90 days** (hard limit, not inactivity-based)

### Accessing the Database

**Via Render Dashboard:**
1. Go to Render Dashboard
2. Select `backstock-db` database
3. Click **Connect** â†’ **External Connection**
4. Copy the connection string

**Via Command Line:**
```bash
# Set the DATABASE_URL from Render dashboard
export DATABASE_URL="postgresql://..."

# Connect with psql
psql $DATABASE_URL

# Run migrations
python manage.py db upgrade

# Check tables
psql $DATABASE_URL -c "\dt"
```

### Database Connection String Format

```
postgresql://USER:PASSWORD@HOST:PORT/DATABASE
```

Render provides this automatically as `DATABASE_URL` environment variable.

---

## 90-Day Database Rotation

### Overview

Render's free PostgreSQL databases **expire after 90 days** from creation. This is a hard limit, not based on inactivity. You must rotate the database before expiration to avoid data loss.

### Rotation Timeline

| Day | Action |
|-----|--------|
| **Day 1** | Database created, application deployed |
| **Day 85** | ðŸ”” Create final backup before rotation |
| **Day 86** | ðŸ†• Create new database on Render |
| **Day 87** | â¬‡ï¸ Restore backup to new database |
| **Day 88** | âœ… Test and verify new database |
| **Day 89** | ðŸ”„ Update DATABASE_URL, deploy |
| **Day 90** | ðŸ—‘ï¸ Delete old database |

### Automated Backup Schedule

The GitHub Actions workflow automatically creates backups:

- **Frequency:** Every Monday at 2 AM UTC
- **Retention:** 90 days
- **Location:** GitHub Releases and Artifacts
- **Workflow:** `.github/workflows/database-backup.yml`

**Manual Backup:**
```bash
# Via GitHub Actions (Recommended)
# 1. Go to Actions tab
# 2. Select "Database Backup" workflow
# 3. Click "Run workflow"

# Via Local Script
export DATABASE_URL="postgresql://..."
./scripts/backup_database.sh
```

### Step-by-Step Rotation Process

#### Step 1: Create Final Backup (Day 85)

```bash
# Option A: Trigger GitHub Actions workflow
# Go to: https://github.com/YOUR_USERNAME/backstock/actions
# Select "Database Backup" â†’ "Run workflow"

# Option B: Manual backup
export DATABASE_URL="your_current_render_database_url"
./scripts/backup_database.sh ./backups
```

**Verify backup:**
```bash
ls -lh backups/
# Should see: backstock_backup_YYYYMMDD_HHMMSS.sql.gz
```

#### Step 2: Create New Database on Render (Day 86)

1. Go to Render Dashboard â†’ **New +** â†’ **PostgreSQL**
2. Configure:
   - **Name:** `backstock-db-v2` (or use date: `backstock-db-20250116`)
   - **Database:** `backstock`
   - **User:** `backstock`
   - **Region:** Same as current (recommended)
   - **Plan:** Free
3. Click **Create Database**
4. Wait 2-3 minutes for provisioning
5. **IMPORTANT:** Copy the **Internal Database URL** (starts with `postgresql://`)

#### Step 3: Restore Backup to New Database (Day 87)

```bash
# Download backup from GitHub Release
# Go to: https://github.com/YOUR_USERNAME/backstock/releases
# Download latest: backstock_backup_YYYYMMDD_HHMMSS.sql.gz

# Set new database URL
export DATABASE_URL="postgresql://new_database_url_from_step_2"

# Restore backup
./scripts/restore_database.sh backups/backstock_backup_YYYYMMDD_HHMMSS.sql.gz

# Verify restoration
psql $DATABASE_URL -c "SELECT COUNT(*) FROM grocery_items;"
```

#### Step 4: Test New Database (Day 88)

**Local Testing:**
```bash
# Update .env with new DATABASE_URL
echo "DATABASE_URL=postgresql://new_database_url" > .env

# Run migrations (if any pending)
python manage.py db upgrade

# Start app locally
python manage.py runserver

# Test key features:
# - Search items
# - Add item
# - Upload CSV
```

**Render Testing (Staging):**
1. Create a test web service pointing to new database
2. Deploy and verify functionality
3. Check logs for any errors

#### Step 5: Update Production DATABASE_URL (Day 89)

**Update via Render Dashboard:**
1. Go to your `backstock` web service
2. Navigate to **Environment** tab
3. Find `DATABASE_URL` variable
4. Click **Edit** â†’ Update to new database URL
5. Click **Save Changes**
6. Render will automatically redeploy with new database

**Verify deployment:**
- Check deployment logs for successful startup
- Visit your app URL
- Test critical functionality
- Monitor error logs

#### Step 6: Delete Old Database (Day 90)

**Only after confirming new database works!**

1. Go to Render Dashboard
2. Select old database (e.g., `backstock-db`)
3. Go to **Settings** tab
4. Scroll to **Danger Zone**
5. Click **Delete Database**
6. Type database name to confirm
7. Click **Delete**

**Final Verification:**
```bash
# Ensure app is still running
curl https://backstock.onrender.com/

# Check database connection
psql $DATABASE_URL -c "SELECT version();"
```

---

## Backup and Restore

### Automated Backups (GitHub Actions)

**Workflow File:** `.github/workflows/database-backup.yml`

**Features:**
- Weekly backups (Monday 2 AM UTC)
- Stored in GitHub Releases
- 90-day retention
- Automatic compression (gzip)

**Manual Trigger:**
1. Go to **Actions** tab in GitHub
2. Select **Database Backup** workflow
3. Click **Run workflow**
4. Optionally add reason for backup
5. Wait for completion
6. Download from **Releases** tab

### Manual Backup Scripts

**Backup Database:**
```bash
export DATABASE_URL="postgresql://..."
./scripts/backup_database.sh [output_directory]

# Example:
./scripts/backup_database.sh ./my-backups

# Output:
# âœ“ Backup completed successfully!
#   File: ./my-backups/backstock_backup_20250116_143022.sql
#   Size: 2.4M
# âœ“ Compressed to backstock_backup_20250116_143022.sql.gz (512K)
```

**Restore Database:**
```bash
export DATABASE_URL="postgresql://new_database_url"
./scripts/restore_database.sh <backup_file>

# Example:
./scripts/restore_database.sh backups/backstock_backup_20250116_143022.sql.gz

# Will prompt for confirmation before overwriting database
```

### Backup Best Practices

1. **Before major changes:** Always backup before schema migrations or bulk updates
2. **Before rotation:** Create backup at Day 85 (5 days before expiration)
3. **Regular testing:** Periodically test restore process to ensure backups work
4. **Multiple copies:** Keep backups in multiple locations (GitHub + local)
5. **Document:** Note what data is in each backup

---

## Troubleshooting

### Deployment Issues

**Build Fails:**
```bash
# Check Render logs
# Dashboard â†’ backstock service â†’ Logs

# Common fixes:
# 1. Verify runtime.txt has correct Python version
# 2. Check requirements.txt is up to date
# 3. Ensure all dependencies are specified
```

**Database Connection Errors:**
```bash
# Verify DATABASE_URL is set correctly
# Dashboard â†’ backstock service â†’ Environment

# Test connection locally
psql $DATABASE_URL -c "SELECT 1;"
```

**SSL Certificate Issues:**
- Render automatically provisions SSL certificates
- May take 5-10 minutes after first deployment
- Check Dashboard â†’ backstock service â†’ Settings â†’ Custom Domain

### Database Issues

**Connection Timeout:**
```bash
# Free tier databases may sleep after inactivity
# First request will be slow (wakes database)
# Subsequent requests will be faster
```

**Out of Storage:**
```bash
# Free tier: 1GB limit
# Check usage:
psql $DATABASE_URL -c "SELECT pg_size_pretty(pg_database_size('backstock'));"

# Solutions:
# 1. Delete old data
# 2. Optimize tables
# 3. Upgrade to paid tier
```

**Database Expiration:**
```bash
# If database expires before rotation:
# 1. Check GitHub Releases for latest backup
# 2. Create new database on Render
# 3. Restore from backup (Step 3 in rotation process)
# 4. Update DATABASE_URL
```

### Backup/Restore Issues

**pg_dump not found:**
```bash
# Install PostgreSQL client
# Ubuntu/Debian:
sudo apt-get install postgresql-client

# macOS:
brew install postgresql
```

**Backup file too large:**
```bash
# Free tier Git LFS may have limits
# Use external storage for large backups:
# - AWS S3
# - Google Drive
# - Dropbox
```

**Restore fails with permission errors:**
```bash
# Ensure you have correct DATABASE_URL
# Must have superuser or database owner privileges
# For Render databases, use the provided connection string
```

---

## Monitoring and Maintenance

### Database Age Tracking

**Check database creation date:**
1. Render Dashboard â†’ `backstock-db`
2. View **Info** section
3. Note **Created** date
4. Calculate expiration: Created Date + 90 days

**Set Calendar Reminders:**
- Day 85: Create backup
- Day 86: Create new database
- Day 89: Update DATABASE_URL

### GitHub Secrets Configuration

Required secrets for automated workflows:

| Secret Name | Description | Where to Get It |
|-------------|-------------|-----------------|
| `RENDER_DATABASE_URL` | PostgreSQL connection string | Render Dashboard â†’ Database â†’ Connect |

**Adding Secrets:**
1. GitHub repo â†’ **Settings** â†’ **Secrets and variables** â†’ **Actions**
2. Click **New repository secret**
3. Add `RENDER_DATABASE_URL`
4. Paste connection string from Render
5. Click **Add secret**

### Health Checks

**Application Health:**
```bash
# Check if app is running
curl https://backstock.onrender.com/

# Check response time
curl -w "@curl-format.txt" -o /dev/null -s https://backstock.onrender.com/
```

**Database Health:**
```bash
# Connection test
psql $DATABASE_URL -c "SELECT 1;"

# Table check
psql $DATABASE_URL -c "\dt"

# Row count
psql $DATABASE_URL -c "SELECT COUNT(*) FROM grocery_items;"
```

---

## Cost Considerations

### Free Tier Limits

**Web Service (Free):**
- Automatic sleep after 15 minutes of inactivity
- 750 hours/month of running time
- Shared CPU/memory
- Slower than paid tiers

**Database (Free):**
- 1 GB storage
- 90-day expiration
- Shared resources

### When to Upgrade

Consider paid tier if:
- Traffic exceeds free tier limits
- Need always-on service (no sleep)
- Require more than 1GB database storage
- Want to avoid 90-day rotation
- Need better performance

**Paid Tier Pricing (as of 2025):**
- Web service: $7/month (basic)
- PostgreSQL: $7/month (basic) - No expiration!

---

## Additional Resources

- [Render Documentation](https://render.com/docs)
- [Render PostgreSQL Guide](https://render.com/docs/databases)
- [GitHub Actions Documentation](https://docs.github.com/en/actions)
- [PostgreSQL Documentation](https://www.postgresql.org/docs/)

---

## Quick Reference

### Important URLs

- Render Dashboard: https://dashboard.render.com
- Your App: https://backstock.onrender.com
- GitHub Actions: https://github.com/YOUR_USERNAME/backstock/actions
- Backup Releases: https://github.com/YOUR_USERNAME/backstock/releases

### Key Commands

```bash
# Backup
export DATABASE_URL="..."
./scripts/backup_database.sh

# Restore
export DATABASE_URL="..."
./scripts/restore_database.sh backups/backup_file.sql.gz

# Connect to database
psql $DATABASE_URL

# Run migrations
python manage.py db upgrade

# Local development
python manage.py runserver
```

### Support

For issues with:
- **Render Platform:** support@render.com
- **Backstock App:** GitHub Issues
- **Deployment:** Check logs in Render Dashboard
